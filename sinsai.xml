<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="sinsai gadget">
<Require feature="dynamic-height" />
<Require feature="settitle" />
<Require feature="views" />
</ModulePrefs>
<Content type="html" view="profile,home"><![CDATA[
<script src="http://d2hv4ldeur9lfv.cloudfront.net/opensocial-jquery-1.3.2.5.min.js"></script>
<a href="javascript:$.view('canvas', { url: 'test' });">sinsai.infoの画面へ</a>
TBDロゴと検索フォームを付ける予定

]]></Content>
<Content type="html" view="canvas"><![CDATA[
<link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" type="text/css"> 
<link rel="stylesheet" href="http://openlayers.org/dev/theme/default/google.css" type="text/css"> 
<link type="text/css" href="http://nati.sinsai.info/gadget/css/south-street/jquery-ui-1.8.11.custom.css" rel="stylesheet" />
<style type="text/css">
<!--
#map{
    width:100%;
    height:100%;
}

.ui-tabs-nav li {
    white-space:	nowrap;
}
.ui-tabs-nav li a {
    padding:		4px 1.5ex 3px !important;
}
.ui-tabs-panel {
    font-size:		1em !important;
}

.ui-layout-center {
    padding:	0;
}


.ui-layout-pane-center .ui-tabs-nav {
    /* don't need border or rounded corners - tabs 'fill' the pane */
    border-top:		0;
    border-left:	0;
    border-right:	0;
    padding-bottom:	0 !important;
    -moz-border-radius:		0;
    -webkit-border-radius:	0;
}

div.field{
    
}

input{
    font-size:1em;
    border: 1px solid #CCC; 
}

#categoryfield {
    margin:5px;
    border:1px solid #cccccc;
    overflow-y:scroll;
    overflow-x:hidden;
    height:80px;
}

#categoryfield input{
    float:left;
}

#categoryfield label{
    width:150px;
    font-size:x-small;
    display:block;
    float:left;
}

#categoryfield label:hover{
     background:#B4EDC5;
}

#search_button{
    width:100%;
}

#more_button{
    width:100%;
}

label {
    width:100px;
    display:block;
    float:left;
}

#debug{
    background:#000000;
    color:#ffffff;
}

div.incident{
    border-top:1px solid #cccccc;
    margin-top:0px;
    margin-bottom:3px;
}

div.incident:hover{
     background:#B4EDC5;
}

div.incident span.date{
    font-size:small;
    float:right;
    margin:2px;
    color:#000000;
    background:#eeeeee;
    margin-top:0px;
}

div.incident span.categories{
    float:right;
    margin:2px;
    margin-top:0px;
}

div.incident div.description{
    border:1px dashed #cccccc;
}


-->
</style>

<script src="http://nati.sinsai.info/gadget/js/opensocial-jquery.min.js"></script>
<script type="text/javascript" src="http://nati.sinsai.info/gadget/js/jquery-ui-1.8.11.custom.min.js"></script>
<script type="text/javascript" src="http://nati.sinsai.info/gadget/js/opensocial-jquery.autoHeight.min.js"></script>
<script type="text/javascript" src="http://nati.sinsai.info/gadget/js/opensocial-jquery.templates.min.js"></script>
<script type="text/javascript" src="http://nati.sinsai.info/gadget/js/jquery.json-2.2.min.js"></script>
<script src="http://layout.jquery-dev.net/lib/js/jquery.layout-latest.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script src="http://openlayers.org/dev/OpenLayers.js"></script> 
<script src="http://nati.sinsai.info/gadget/js/timeline.js"></script>
<script src="http://nati.sinsai.info/gadget/js/opensocial-jquery.autoHeight.min.js"></script>
<script src="http://nati.sinsai.info/gadget/js/ushahidi_gadget.js"></script> 
<script language="javascript">
var map;
var proj_4326 = new OpenLayers.Projection('EPSG:4326');
var longitude = 140.48981665651;
var latitude = 37.609377136228;
var defaultZoom = 6;
var endpoint = "http://www.sinsai.info/ushahidi/";

$.log = function(msg){
    $("#debug").html(msg + "<br>" +  $("#debug").html());
}

$(function($,data) {
    var ushahidi = $.ushahidi({"endpoint":endpoint});
    var searchLayer = "検索結果";
    var renderIncidents = function (data){
       var searchMaker = new OpenLayers.Layer.Markers(searchLayer);
       var markers = map.getLayersByName(searchLayer);
        if (markers && markers.length > 0)
        {
	        for (var i = 0; i < markers.length; i++)
	        {
		        map.removeLayer(markers[i]);
	        }
        }
       map.addLayer(searchMaker);
           
      $.each(data,function(){ 
           var incident = this.incident;
           var place = ushahidi.lonlat4326(incident.locationlongitude,incident.locationlatitude);
           var icon = ushahidi.icon(ushahidi.catICON[this.categories[0].category.id]);
           var marker = new OpenLayers.Marker(place, icon);
           incident.categories = [];
           $.each(this.categories,function(){
                    incident.categories.push({url:ushahidi.catICON[this.category.id]});
           });
			searchMaker.addMarker(marker);
       });
       $('#incidents').render({ incidents: data }).show();
       $(".description").hide();
       $(".incident").each(function () {
            var flip = 0;
            var description = $(".description",this);
            var body = description.html() ;
            body = body.replace(/\r\n/g, "<br/>");
	        body = body.replace(/(\n|\r)/g, "<br/>");
            description.html(body);
            $(".title",this).click(function(){
                description.toggle( flip++ % 2 == 0 );
            });
        });
    }
           
        
    function mapEvent(event) {
        $.log("map move");
        var center = map.getCenter();
        var zoom = map.zoom;
        ushahidi.lonlat2Address(center,function(address){
                $("#address").val(address);
        });
        $("#zoom").val(zoom);
        var bound = map.getExtent().transform(map.getProjectionObject(),
            new OpenLayers.Projection("EPSG:4326"));
        southwest = bound .left+','+bound .bottom;
        northeast = bound.right+','+bound .top;
        $.log(southwest + "," + northeast);
        ushahidi.incidentsByBounds(center,southwest,northeast,$("#keyword").val(),$("input[name=catID]:checked").val(),renderIncidents);


    }

    map = new OpenLayers.Map({
        div: "map",
        allOverlays: true,
        eventListeners: {
            "moveend": mapEvent,
            //"zoomend": mapEvent,
        }
    });

    
    
    var layout = $('body').layout({
        applyDefaultStyles: true,
        resizable:  true,
        slidable: true,
        north__size:230,
        east__size:Math.floor($(window).width() / 2)
    });
    $( "#tabs" ).tabs();
    $(".ui-layout-center").tabs().find(".ui-tabs-nav").sortable({ axis: 'x', zIndex: 2 })
    $(".ui-layout-center").removeClass("ui-corner-all");
    $(".ui-layout-center").css("padding","0px");

    layout.resizeAll();
    var osm = new OpenLayers.Layer.OSM();
    var gmap = new OpenLayers.Layer.Google("Google Streets", {visibility: false});

    // note that first layer must be visible
    map.addLayers([osm, gmap]);
    
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.zoomToMaxExtent();
    var lonlat = ushahidi.lonlat4326(longitude,latitude);
    map.setCenter(lonlat, defaultZoom);
    $.each(ushahidi.zoomLevel, function(key){
        var value = this;
        var selected = key == defaultZoom ? "selected" : "" ;
        $("#zoom").prepend("<option value='"+ key +"' " + selected +  " >" + ushahidi.zoom2DistanceLabel(key) + "</option>");
    });
    ushahidi.category(function(json){
        var index = 2;
        var num = Math.floor($(window).width()/180); //label width
        var radio = '<input type="radio" value="0" name="catID" id="0" /><label for="0" ><img src="http://www.sinsai.info/ushahidi/media/img/all.png" alt="すべて"/>全て</label>';
        $("#categoryfield").append(radio);
        $.each(json,function(){
            var radio = '<input type="radio" value="' + this.category.id + '" name="catID" id="'+ this.category.id +'" /><label for="'+ this.category.id +'" ><img src="' + this.category.image_thumb + '" alt="' + this.category.title + '"/>'+this.category.title+'</label>';
            $("#categoryfield").append(radio);
            if( index % num == 0 ){
                $("#categoryfield").append("<br style='clear:both;'/>");
            }
            index++;
            ushahidi.catICON[this.category.id] = this.category.image_thumb;
        });
        
        $(".category").addClass("ui-corner-all");
    });
    
    
    
    $("#search").submit(function(){
        $.log("test");
        ushahidi.address2Lonlat($("#address").val(),function(lonlat){
            $.log(lonlat);
            map.setCenter(ushahidi.lonlat(lonlat.lon,lonlat.lat), $("#zoom").val());
        });
        return false;
    });
    
   // ushahidi.allIncidents(renderIncidents);
});
</script>
<DIV class="ui-layout-center">
	<ul>
		<li><a href="#tabs-1">レポート</a></li>
		<li><a href="#tabs-2">投稿</a></li>
		<li><a href="#tabs-3">最新コメント</a></li>
	</ul>
	<div id="tabs-1">

<div id="incidents" style="display:none;">
<div repeat="${incidents}" class="incidents">
<div class="incident">
<span repeat="${Cur.incident.categories}" class="categories">
<img src="${Cur.url}"/>
</span>
<span class="date">${Cur.incident.incidentdate } </span>
<div class="title">${Cur.incident.incidenttitle } </div>
<div class="description">${Cur.incident.incidentdescription }
<a href="http://www.sinsai.info/ushahidi/reports/view/${Cur.incident.incidentid}">コメントする</a><br>
<span repeat="${Cur.media}" class="link" >
<a href="${Cur.link}" target="brank">情報元リンク${Cur.index}</a><br>
</span>
</div>
</div>
</div>
<input id="more_button" type="button" value="次の情報"/>

<div if="${incidents.length == 0}" class="pager">There's no reports yet.</div>
</div>

	</div>
	<div id="tabs-2">
    <h1>Uniform Demo</h1> 
    
	</div>
	<div id="tabs-3">
		<p>最新コメント</p>
	</div>
</DIV>
<DIV class="ui-layout-north">
<form id="search">
<div class="field">
<label>住所</label><input type="text" size="40" id="address"/>
</div>
<div class="field">
<label>縮尺</label><select id="zoom"/>
</div>
<div class="field">
<label>キーワード</label><input type="text" size="40" id="keyword"/>
</div>
<div class="field">
<label>カテゴリ</label><br style="clear:both;"/>
<div id="categoryfield">
</div>
</div>
<div class="field">
<input id="search_button" type="submit" value="検索"/>
</div>
</DIV>
</form>

<DIV class="ui-layout-south"><div id="debug"></div></DIV>
<DIV class="ui-layout-east"><div id="map" class="smallmap"></div></DIV>

]]>
</Content>
</Module>
